<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartCookware - Control BLE</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        .card {
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 15px;
            text-align: center;
            font-size: 16px;
            margin: 5px 2px;
            cursor: pointer;
            border-radius: 5px;
            width: 100%;
        }
        button:disabled {
            background-color: #cccccc;
        }
        .temperature {
            font-size: 36px;
            text-align: center;
            margin: 20px 0;
        }
        .status {
            font-size: 14px;
            color: #555;
            text-align: center;
        }
        .progress-container {
            width: 100%;
            background-color: #ddd;
            border-radius: 5px;
        }
        .progress-bar {
            height: 20px;
            background-color: #4CAF50;
            border-radius: 5px;
            text-align: center;
            color: white;
            line-height: 20px;
        }
        .step-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        .action-required {
            background-color: #f44336;
            color: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin: 15px 0;
        }
        .hidden {
            display: none;
        }
        
        .input-group {
            margin: 10px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .button-small {
            width: auto;
            padding: 5px 10px;
            margin: 5px;
            font-size: 14px;
        }
        
        .flex-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .flex-container input {
            flex: 1;
        }
    </style>
</head>
<body>
    <h1>SmartCookware</h1>
    
    <div class="card">
        <button id="connectButton">Conectar dispositivo</button>
        <p class="status" id="statusText">Desconectado</p>
        <p class="status" id="batteryText"></p>
    </div>
    
    <div class="card hidden" id="temperatureCard">
        <h2>Temperatura</h2>
        <div class="temperature" id="currentTemp">--°C</div>
        <div id="setpointContainer" class="hidden">
            <p>Temperatura objetivo: <span id="tempSetpoint">--°C</span></p>
        </div>
    </div>
    
    <div class="card hidden" id="recipeProgressCard">
        <h2>Progreso de receta</h2>
        <div class="step-info">
            <span id="stepInfo">Paso: --/--</span>
            <span id="timeRemaining">--:--</span>
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar" style="width:0%">0%</div>
        </div>
    </div>
    
    <div class="action-required hidden" id="actionRequiredCard">
        <h2>¡ACCIÓN REQUERIDA!</h2>
        <p>Por favor, realiza la acción necesaria y pulsa el botón cuando hayas terminado.</p>
        <button id="continueButton">CONTINUAR</button>
    </div>

    <!-- Nueva sección para controles de envío -->
    <div class="card hidden" id="controlsCard">
        <h2>Controles de Receta</h2>
        
        <!-- Control para enviar paso de receta -->
        <div class="input-group">
            <label>Configurar Paso de Receta:</label>
            <div class="flex-container">
                <input type="number" id="stepNumber" placeholder="Paso" min="1" max="10" value="1">
                <input type="number" id="totalStepsInput" placeholder="Total" min="1" max="10" value="5">
            </div>
            <div class="flex-container">
                <input type="number" id="targetTemp" placeholder="Temp. objetivo (°C)" min="0" max="300" value="180">
                <select id="actionRequired">
                    <option value="0">Sin acción requerida</option>
                    <option value="1">Acción requerida</option>
                </select>
            </div>
            <button class="button-small" onclick="sendRecipeStepManual()">Enviar Paso</button>
        </div>
        
        <!-- Control para enviar progreso de tiempo -->
        <div class="input-group">
            <label>Configurar Tiempo:</label>
            <div class="flex-container">
                <input type="number" id="remainingTimeInput" placeholder="Tiempo restante (seg)" min="0" max="3600" value="300">
                <input type="number" id="totalTimeInput" placeholder="Tiempo total (seg)" min="1" max="3600" value="600">
            </div>
            <button class="button-small" onclick="sendRecipeProgressManual()">Enviar Tiempo</button>
        </div>
        
        <!-- Recetas predefinidas -->
        <div class="input-group">
            <label>Recetas Predefinidas:</label>
            <button class="button-small" onclick="startPaellaRecipe()">Paella Valenciana</button>
            <button class="button-small" onclick="startSteakRecipe()">Filete a la Plancha</button>
            <button class="button-small" onclick="startPastaRecipe()">Pasta Italiana</button>
        </div>
        
        <!-- Control manual para reset -->
        <div class="input-group">
            <button class="button-small" onclick="resetRecipe()">Reset Receta</button>
            <button class="button-small" onclick="testContinueNotification()">Test Continuar</button>
        </div>
    </div>

    <script>
        // UUIDs de los servicios y características BLE - usando formato UUID completo
        // Para los servicios estándar, usamos el formato completo
        const BATTERY_SERVICE_UUID = '0000180f-0000-1000-8000-00805f9b34fb';
        const BATTERY_CHARACTERISTIC_UUID = '00002a19-0000-1000-8000-00805f9b34fb';
        
        // Para servicios personalizados, mantenemos el UUID tal como está
        const COOKING_SERVICE_UUID = 'abcd1234-5678-9012-3456-7890abcdef12';
        const TEMP_CHARACTERISTIC_UUID = 'abcd1234-0001-9012-3456-7890abcdef12';
        const PROGRESS_CHARACTERISTIC_UUID = 'abcd1234-0002-9012-3456-7890abcdef12';
        const STEPS_CHARACTERISTIC_UUID = 'abcd1234-0003-9012-3456-7890abcdef12';
        const CONTINUE_CHARACTERISTIC_UUID = 'abcd1234-0005-9012-3456-7890abcdef12';
        
        // Variables globales
        let device = null;
        let batteryCharacteristic = null;
        let tempCharacteristic = null;
        let progressCharacteristic = null;
        let stepsCharacteristic = null;
        let continueCharacteristic = null;
        
        // Elementos del DOM
        const connectButton = document.getElementById('connectButton');
        const statusText = document.getElementById('statusText');
        const batteryText = document.getElementById('batteryText');
        const temperatureCard = document.getElementById('temperatureCard');
        const currentTemp = document.getElementById('currentTemp');
        const setpointContainer = document.getElementById('setpointContainer');
        const tempSetpoint = document.getElementById('tempSetpoint');
        const recipeProgressCard = document.getElementById('recipeProgressCard');
        const stepInfo = document.getElementById('stepInfo');
        const timeRemaining = document.getElementById('timeRemaining');
        const progressBar = document.getElementById('progressBar');
        const actionRequiredCard = document.getElementById('actionRequiredCard');
        const continueButton = document.getElementById('continueButton');
        const controlsCard = document.getElementById('controlsCard');
        
        // Eventos
        connectButton.addEventListener('click', connectToDevice);
        continueButton.addEventListener('click', sendContinueSignal);
        
        // Verificar si el navegador soporta Web Bluetooth
        if (!navigator.bluetooth) {
            statusText.textContent = 'Web Bluetooth no soportado por este navegador';
            connectButton.disabled = true;
        }
        
        async function connectToDevice() {
            try {
                statusText.textContent = 'Buscando dispositivos...';
                console.log('Intentando conectar...');
                
                // Cambiamos a especificar directamente todos los servicios
                // sin hacer referencia a las variables constantes
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'SmartCookware' }],
                    optionalServices: [
                        '0000180f-0000-1000-8000-00805f9b34fb', // Battery Service
                        'abcd1234-5678-9012-3456-7890abcdef12'  // Cooking Service
                    ]
                });
                
                statusText.textContent = 'Conectando...';
                
                // Conectar al dispositivo
                const server = await device.gatt.connect();
                
                // Manejar desconexiones
                device.addEventListener('gattserverdisconnected', onDisconnected);
                
                // Obtener servicio de batería - usando directamente el UUID
                const batteryService = await server.getPrimaryService('0000180f-0000-1000-8000-00805f9b34fb');
                batteryCharacteristic = await batteryService.getCharacteristic('00002a19-0000-1000-8000-00805f9b34fb');
                
                // Suscribirse a notificaciones de batería
                await batteryCharacteristic.startNotifications();
                batteryCharacteristic.addEventListener('characteristicvaluechanged', handleBatteryChange);
                
                // Leer nivel de batería inicial
                const batteryValue = await batteryCharacteristic.readValue();
                updateBatteryLevel(batteryValue);
                
                // Obtener servicio de cocina - usando directamente el UUID
                const cookingService = await server.getPrimaryService('abcd1234-5678-9012-3456-7890abcdef12');
                
                // Obtener características usando directamente los UUIDs
                tempCharacteristic = await cookingService.getCharacteristic('abcd1234-0001-9012-3456-7890abcdef12');
                progressCharacteristic = await cookingService.getCharacteristic('abcd1234-0002-9012-3456-7890abcdef12');
                stepsCharacteristic = await cookingService.getCharacteristic('abcd1234-0003-9012-3456-7890abcdef12');
                continueCharacteristic = await cookingService.getCharacteristic('abcd1234-0005-9012-3456-7890abcdef12');
                
                // Suscribirse a notificaciones de temperatura
                await tempCharacteristic.startNotifications();
                tempCharacteristic.addEventListener('characteristicvaluechanged', handleTemperatureChange);
                
                // Suscribirse a notificaciones de continuar
                await continueCharacteristic.startNotifications();
                continueCharacteristic.addEventListener('characteristicvaluechanged', handleContinueChange);
                
                // Leer temperatura inicial
                const tempValue = await tempCharacteristic.readValue();
                updateTemperature(tempValue);
                
                // Actualizar UI
                statusText.textContent = 'Conectado';
                connectButton.textContent = 'Desconectar';
                connectButton.removeEventListener('click', connectToDevice);
                connectButton.addEventListener('click', disconnectDevice);
                
                // Mostrar tarjeta de temperatura y controles
                temperatureCard.classList.remove('hidden');
                controlsCard.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error al conectar:', error);
                statusText.textContent = 'Error: ' + error.message;
                // Mostrar más información de debug en la consola
                console.log('Error detallado:', error);
                alert('Error al conectar: ' + error.message);
            }
        }
        
        function disconnectDevice() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }
        }
        
        function onDisconnected() {
            statusText.textContent = 'Desconectado';
            batteryText.textContent = '';
            connectButton.textContent = 'Conectar dispositivo';
            connectButton.removeEventListener('click', disconnectDevice);
            connectButton.addEventListener('click', connectToDevice);
            
            // Ocultar tarjetas
            temperatureCard.classList.add('hidden');
            recipeProgressCard.classList.add('hidden');
            actionRequiredCard.classList.add('hidden');
            controlsCard.classList.add('hidden');
            
            // Resetear variables
            device = null;
            batteryCharacteristic = null;
            tempCharacteristic = null;
            progressCharacteristic = null;
            stepsCharacteristic = null;
            continueCharacteristic = null;
        }
        
        function handleBatteryChange(event) {
            updateBatteryLevel(event.target.value);
        }
        
        function updateBatteryLevel(value) {
            const batteryLevel = value.getUint8(0);
            batteryText.textContent = `Batería: ${batteryLevel}%`;
        }
        
        function handleTemperatureChange(event) {
            updateTemperature(event.target.value);
        }
        
        function updateTemperature(value) {
            // La temperatura es un uint16 (2 bytes)
            const temp = value.getUint16(0, false); // false = big-endian
            currentTemp.textContent = `${temp}°C`;
        }
        
        function handleContinueChange(event) {
            const continueValue = event.target.value.getUint8(0);
            if (continueValue === 1) {
                // La acción ya fue atendida en el dispositivo
                actionRequiredCard.classList.add('hidden');
            }
        }
        
        async function sendContinueSignal() {
            if (!continueCharacteristic) return;
            
            try {
                // Enviar señal de continuar (valor 1)
                const value = new Uint8Array([1]);
                await continueCharacteristic.writeValue(value);
                
                // Ocultar tarjeta de acción requerida
                actionRequiredCard.classList.add('hidden');
                
                statusText.textContent = 'Acción completada';
            } catch (error) {
                console.error('Error al enviar señal de continuar:', error);
                statusText.textContent = 'Error: ' + error.message;
            }
        }
        
        // Funciones para enviar datos al dispositivo
        
        async function sendRecipeStep(step, totalSteps, actionRequired, tempTarget) {
            if (!stepsCharacteristic) return;
            
            try {
                // Crear array de 5 bytes:
                // [paso actual, total pasos, acción requerida, tempTarget MSB, tempTarget LSB]
                const data = new Uint8Array([
                    step, 
                    totalSteps,
                    actionRequired ? 1 : 0,
                    (tempTarget >> 8) & 0xFF,
                    tempTarget & 0xFF
                ]);
                
                await stepsCharacteristic.writeValue(data);
                
                // Actualizar UI según los valores enviados
                stepInfo.textContent = `Paso: ${step}/${totalSteps}`;
                recipeProgressCard.classList.remove('hidden');
                
                if (tempTarget > 0) {
                    tempSetpoint.textContent = `${tempTarget}°C`;
                    setpointContainer.classList.remove('hidden');
                }
                
                if (actionRequired) {
                    actionRequiredCard.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Error al enviar paso de receta:', error);
                statusText.textContent = 'Error: ' + error.message;
            }
        }
        
        async function sendRecipeProgress(remainingTime, totalTime) {
            if (!progressCharacteristic) return;
            
            try {
                // Crear array de 4 bytes:
                // [remainingTime MSB, remainingTime LSB, totalTime MSB, totalTime LSB]
                const data = new Uint8Array([
                    (remainingTime >> 8) & 0xFF,
                    remainingTime & 0xFF,
                    (totalTime >> 8) & 0xFF,
                    totalTime & 0xFF
                ]);
                
                await progressCharacteristic.writeValue(data);
                
                // Actualizar UI
                updateTimeDisplay(remainingTime, totalTime);
                
            } catch (error) {
                console.error('Error al enviar progreso de receta:', error);
            }
        }
        
        function updateTimeDisplay(remainingTime, totalTime) {
            // Calcular minutos y segundos
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            
            // Formatear tiempo (mm:ss)
            const timeStr = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            timeRemaining.textContent = timeStr;
            
            // Actualizar barra de progreso
            let progress = 0;
            if (totalTime > 0) {
                progress = Math.floor(100 * (1 - remainingTime / totalTime));
            }
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${progress}%`;
        }
        
        // Nuevas funciones para controles manuales
        
        async function sendRecipeStepManual() {
            const step = parseInt(document.getElementById('stepNumber').value);
            const totalSteps = parseInt(document.getElementById('totalStepsInput').value);
            const tempTarget = parseInt(document.getElementById('targetTemp').value);
            const actionReq = parseInt(document.getElementById('actionRequired').value);
            
            if (!step || !totalSteps || tempTarget < 0) {
                alert('Por favor, completa todos los campos correctamente');
                return;
            }
            
            await sendRecipeStep(step, totalSteps, actionReq === 1, tempTarget);
            statusText.textContent = `Paso ${step}/${totalSteps} enviado`;
        }
        
        async function sendRecipeProgressManual() {
            const remainingTime = parseInt(document.getElementById('remainingTimeInput').value);
            const totalTime = parseInt(document.getElementById('totalTimeInput').value);
            
            if (remainingTime < 0 || totalTime <= 0 || remainingTime > totalTime) {
                alert('Tiempo inválido. El tiempo restante debe ser menor o igual al total');
                return;
            }
            
            await sendRecipeProgress(remainingTime, totalTime);
            statusText.textContent = `Tiempo actualizado: ${remainingTime}/${totalTime} seg`;
        }
        
        // Recetas predefinidas
        
        async function startPaellaRecipe() {
            if (!device || !device.gatt.connected) {
                alert('Dispositivo no conectado');
                return;
            }
            
            statusText.textContent = 'Iniciando receta de Paella...';
            
            // Paso 1: Calentar aceite
            await sendRecipeStep(1, 4, false, 180);
            await sendRecipeProgress(300, 300); // 5 minutos
            
            setTimeout(async () => {
                // Paso 2: Sofreír verduras - requiere acción del usuario
                await sendRecipeStep(2, 4, true, 160);
                await sendRecipeProgress(600, 600); // 10 minutos
            }, 2000);
        }
        
        async function startSteakRecipe() {
            if (!device || !device.gatt.connected) {
                alert('Dispositivo no conectado');
                return;
            }
            
            statusText.textContent = 'Iniciando receta de Filete...';
            
            // Paso 1: Precalentar sartén
            await sendRecipeStep(1, 3, false, 220);
            await sendRecipeProgress(180, 180); // 3 minutos
            
            setTimeout(async () => {
                // Paso 2: Añadir filete - requiere acción
                await sendRecipeStep(2, 3, true, 200);
                await sendRecipeProgress(240, 240); // 4 minutos por lado
            }, 2000);
        }
        
        async function startPastaRecipe() {
            if (!device || !device.gatt.connected) {
                alert('Dispositivo no conectado');
                return;
            }
            
            statusText.textContent = 'Iniciando receta de Pasta...';
            
            // Paso 1: Hervir agua
            await sendRecipeStep(1, 3, false, 100);
            await sendRecipeProgress(480, 480); // 8 minutos
            
            setTimeout(async () => {
                // Paso 2: Añadir pasta - requiere acción
                await sendRecipeStep(2, 3, true, 100);
                await sendRecipeProgress(600, 600); // 10 minutos cocción
            }, 2000);
        }
        
        async function resetRecipe() {
            if (!device || !device.gatt.connected) {
                alert('Dispositivo no conectado');
                return;
            }
            
            // Enviar paso 0 para resetear
            await sendRecipeStep(0, 0, false, 0);
            await sendRecipeProgress(0, 0);
            
            // Ocultar tarjetas de progreso y acción
            recipeProgressCard.classList.add('hidden');
            actionRequiredCard.classList.add('hidden');
            setpointContainer.classList.add('hidden');
            
            statusText.textContent = 'Receta reseteada';
        }
        
        async function testContinueNotification() {
            if (!continueCharacteristic) {
                alert('Característica de continuar no disponible');
                return;
            }
            
            try {
                // Simular que se requiere una acción
                await sendRecipeStep(1, 1, true, 150);
                
                setTimeout(() => {
                    statusText.textContent = 'Test: Mostrando acción requerida';
                }, 1000);
                
            } catch (error) {
                console.error('Error en test:', error);
                statusText.textContent = 'Error en test: ' + error.message;
            }
        }
    </script>
</body>
</html>
