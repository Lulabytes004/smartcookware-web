<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartCookware - Control BLE</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        .card {
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 15px;
            text-align: center;
            font-size: 16px;
            margin: 5px 2px;
            cursor: pointer;
            border-radius: 5px;
            width: 100%;
        }
        button:disabled {
            background-color: #cccccc;
        }
        .temperature {
            font-size: 36px;
            text-align: center;
            margin: 20px 0;
        }
        .status {
            font-size: 14px;
            color: #555;
            text-align: center;
        }
        .progress-container {
            width: 100%;
            background-color: #ddd;
            border-radius: 5px;
        }
        .progress-bar {
            height: 20px;
            background-color: #4CAF50;
            border-radius: 5px;
            text-align: center;
            color: white;
            line-height: 20px;
        }
        .step-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        .action-required {
            background-color: #f44336;
            color: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin: 15px 0;
        }
        .hidden {
            display: none;
        }
        
        .input-group {
            margin: 10px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .button-small {
            width: auto;
            padding: 5px 10px;
            margin: 5px;
            font-size: 14px;
        }
        
        .flex-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .flex-container input {
            flex: 1;
        }
        
        .version-info {
            text-align: center;
            font-size: 12px;
            color: #888;
            margin-bottom: 20px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>SmartCookware</h1>
    <div class="version-info">Versi√≥n 2.5.0 - Build 20241212-005</div>
    
    <div class="card">
        <button id="connectButton">Conectar dispositivo</button>
        <p class="status" id="statusText">Desconectado</p>
        <p class="status" id="batteryText"></p>
    </div>
    
    <div class="card hidden" id="temperatureCard">
        <h2>Temperatura</h2>
        <div class="temperature" id="currentTemp">--¬∞C</div>
        <div id="setpointContainer" class="hidden">
            <p>Temperatura objetivo: <span id="tempSetpoint">--¬∞C</span></p>
        </div>
    </div>
    
    <div class="card hidden" id="recipeProgressCard">
        <h2>Progreso de receta</h2>
        <div class="step-info">
            <span id="stepInfo">Paso: --/--</span>
            <span id="timeRemaining">--:--</span>
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar" style="width:0%">0%</div>
        </div>
    </div>
    
    <div class="action-required hidden" id="actionRequiredCard">
        <h2>¬°ACCI√ìN REQUERIDA!</h2>
        <p>Por favor, realiza la acci√≥n necesaria y pulsa el bot√≥n cuando hayas terminado.</p>
        <button id="continueButton">CONTINUAR</button>
    </div>

    <!-- Nueva secci√≥n para controles de env√≠o -->
    <div class="card hidden" id="controlsCard">
        <h2>Controles de Receta</h2>
        
        <!-- Control para enviar paso de receta - MEJORADO -->
        <div class="input-group">
            <label>Caracter√≠stica BLE: Steps (Configuraci√≥n de Paso):</label>
            <div class="flex-container">
                <div style="flex: 1;">
                    <label style="font-size: 12px; color: #666;">Paso:</label>
                    <input type="number" id="stepNumber" placeholder="Paso actual" min="0" max="10" value="1">
                </div>
                <div style="flex: 1;">
                    <label style="font-size: 12px; color: #666;">Total Pasos:</label>
                    <input type="number" id="totalStepsInput" placeholder="Total de pasos" min="0" max="10" value="2">
                </div>
            </div>
            <div class="flex-container">
                <div style="flex: 1;">
                    <label style="font-size: 12px; color: #666;">Acci√≥n Requerida:</label>
                    <select id="actionRequired">
                        <option value="0">Sin acci√≥n requerida</option>
                        <option value="1">‚ö†Ô∏è Acci√≥n requerida</option>
                    </select>
                </div>
                <div style="flex: 1;">
                    <label style="font-size: 12px; color: #666;">Temperatura Setpoint:</label>
                    <input type="number" id="targetTemp" placeholder="Temp. objetivo (¬∞C)" min="0" max="300" value="180">
                </div>
            </div>
            <button class="button-small" onclick="sendRecipeStepManual()" style="width: 100%; margin-top: 10px;">üì§ Enviar Configuraci√≥n de Paso</button>
        </div>
        
        <!-- Control para enviar progreso de tiempo - SIMPLIFICADO -->
        <div class="input-group">
            <label>Caracter√≠stica BLE: Progress (Tiempo del Paso):</label>
            <div style="flex: 1; margin-bottom: 10px;">
                <label style="font-size: 12px; color: #666;">Tiempo Total del Paso (seg):</label>
                <input type="number" id="totalTimeInput" placeholder="Duraci√≥n total del paso" min="1" max="7200" value="300">
            </div>
            <div style="display: flex; gap: 10px; font-size: 12px; color: #666; margin-top: 5px;">
                <span>Ejemplo: 300 seg = 5:00 min</span>
                <span>|</span>
                <span>1800 seg = 30:00 min</span>
            </div>
            <div style="font-size: 11px; color: #888; margin-top: 5px; font-style: italic;">
                * Al enviar, se iniciar√° autom√°ticamente desde el tiempo total especificado
            </div>
            <button class="button-small" onclick="sendRecipeProgressManual()" style="width: 100%; margin-top: 10px;">‚è∞ Iniciar Timer del Paso</button>
        </div>
        
        <!-- Recetas predefinidas -->
        <div class="input-group">
            <label>Recetas Predefinidas:</label>
            <button class="button-small" onclick="startPaellaRecipe()">Paella Valenciana</button>
            <button class="button-small" onclick="startSteakRecipe()">Filete a la Plancha</button>
            <button class="button-small" onclick="startPastaRecipe()">Pasta Italiana</button>
        </div>
        
        <!-- Control manual para reset -->
        <div class="input-group">
            <button class="button-small" onclick="resetRecipe()">Reset Receta</button>
            <button class="button-small" onclick="nextStep()">Siguiente Paso</button>
            <button class="button-small" onclick="testContinueNotification()">Test Continuar</button>
        </div>
    </div>

    <script>
        // Mostrar informaci√≥n de versi√≥n en la consola para debug
        console.log('SmartCookware Web App - Versi√≥n 2.5.0');
        console.log('Build: 20241212-005');
        console.log('Caracter√≠sticas: UI simplificada para tiempo, inicio autom√°tico desde tiempo total');
        
        // UUIDs de los servicios y caracter√≠sticas BLE - usando formato UUID completo
        // Para los servicios est√°ndar, usamos el formato completo
        const BATTERY_SERVICE_UUID = '0000180f-0000-1000-8000-00805f9b34fb';
        const BATTERY_CHARACTERISTIC_UUID = '00002a19-0000-1000-8000-00805f9b34fb';
        
        // Para servicios personalizados, mantenemos el UUID tal como est√°
        const COOKING_SERVICE_UUID = 'abcd1234-5678-9012-3456-7890abcdef12';
        const TEMP_CHARACTERISTIC_UUID = 'abcd1234-0001-9012-3456-7890abcdef12';
        const PROGRESS_CHARACTERISTIC_UUID = 'abcd1234-0002-9012-3456-7890abcdef12';
        const STEPS_CHARACTERISTIC_UUID = 'abcd1234-0003-9012-3456-7890abcdef12';
        const CONTINUE_CHARACTERISTIC_UUID = 'abcd1234-0005-9012-3456-7890abcdef12';
        
        // Variables para el contador de tiempo autom√°tico - A√ëADIR ESTAS VARIABLES
        let timerInterval = null;
        let currentRemainingTime = 0;
        let currentTotalTime = 0;
        let isTimerActive = false;
        
        // Variables globales
        let device = null;
        let batteryCharacteristic = null;
        let tempCharacteristic = null;
        let progressCharacteristic = null;
        let stepsCharacteristic = null;
        let continueCharacteristic = null;
        
        // Elementos del DOM
        const connectButton = document.getElementById('connectButton');
        const statusText = document.getElementById('statusText');
        const batteryText = document.getElementById('batteryText');
        const temperatureCard = document.getElementById('temperatureCard');
        const currentTemp = document.getElementById('currentTemp');
        const setpointContainer = document.getElementById('setpointContainer');
        const tempSetpoint = document.getElementById('tempSetpoint');
        const recipeProgressCard = document.getElementById('recipeProgressCard');
        const stepInfo = document.getElementById('stepInfo');
        const timeRemaining = document.getElementById('timeRemaining');
        const progressBar = document.getElementById('progressBar');
        const actionRequiredCard = document.getElementById('actionRequiredCard');
        const continueButton = document.getElementById('continueButton');
        const controlsCard = document.getElementById('controlsCard');
        
        // Eventos
        connectButton.addEventListener('click', connectToDevice);
        continueButton.addEventListener('click', sendContinueSignal);
        
        // Verificar si el navegador soporta Web Bluetooth
        if (!navigator.bluetooth) {
            statusText.textContent = 'Web Bluetooth no soportado por este navegador';
            connectButton.disabled = true;
        }
        
        async function connectToDevice() {
            try {
                statusText.textContent = 'Buscando dispositivos...';
                console.log('Intentando conectar... (v2.5.0)');
                
                // Cambiamos a especificar directamente todos los servicios
                // sin hacer referencia a las variables constantes
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'SmartCookware' }],
                    optionalServices: [
                        '0000180f-0000-1000-8000-00805f9b34fb', // Battery Service
                        'abcd1234-5678-9012-3456-7890abcdef12'  // Cooking Service
                    ]
                });
                
                statusText.textContent = 'Conectando...';
                
                // Conectar al dispositivo
                const server = await device.gatt.connect();
                
                // Manejar desconexiones
                device.addEventListener('gattserverdisconnected', onDisconnected);
                
                // Obtener servicio de bater√≠a - usando directamente el UUID
                const batteryService = await server.getPrimaryService('0000180f-0000-1000-8000-00805f9b34fb');
                batteryCharacteristic = await batteryService.getCharacteristic('00002a19-0000-1000-8000-00805f9b34fb');
                
                // Suscribirse a notificaciones de bater√≠a
                await batteryCharacteristic.startNotifications();
                batteryCharacteristic.addEventListener('characteristicvaluechanged', handleBatteryChange);
                
                // Leer nivel de bater√≠a inicial
                const batteryValue = await batteryCharacteristic.readValue();
                updateBatteryLevel(batteryValue);
                
                // Obtener servicio de cocina - usando directamente el UUID
                const cookingService = await server.getPrimaryService('abcd1234-5678-9012-3456-7890abcdef12');
                
                // Obtener caracter√≠sticas usando directamente los UUIDs
                tempCharacteristic = await cookingService.getCharacteristic('abcd1234-0001-9012-3456-7890abcdef12');
                progressCharacteristic = await cookingService.getCharacteristic('abcd1234-0002-9012-3456-7890abcdef12');
                stepsCharacteristic = await cookingService.getCharacteristic('abcd1234-0003-9012-3456-7890abcdef12');
                continueCharacteristic = await cookingService.getCharacteristic('abcd1234-0005-9012-3456-7890abcdef12');
                
                // Suscribirse a notificaciones de temperatura
                await tempCharacteristic.startNotifications();
                tempCharacteristic.addEventListener('characteristicvaluechanged', handleTemperatureChange);
                
                // Suscribirse a notificaciones de continuar
                await continueCharacteristic.startNotifications();
                continueCharacteristic.addEventListener('characteristicvaluechanged', handleContinueChange);
                
                // Leer temperatura inicial
                const tempValue = await tempCharacteristic.readValue();
                updateTemperature(tempValue);
                
                // Actualizar UI
                statusText.textContent = 'Conectado';
                connectButton.textContent = 'Desconectar';
                connectButton.removeEventListener('click', connectToDevice);
                connectButton.addEventListener('click', disconnectDevice);
                
                // Mostrar tarjeta de temperatura y controles - CORREGIDO
                temperatureCard.classList.remove('hidden');
                controlsCard.classList.remove('hidden');
                
                // Debug para verificar que se muestran los controles
                console.log('Controles mostrados:', !controlsCard.classList.contains('hidden'));
                console.log('Versi√≥n de la app:', '2.5.0');
                
            } catch (error) {
                console.error('Error al conectar:', error);
                statusText.textContent = 'Error: ' + error.message;
                // Mostrar m√°s informaci√≥n de debug en la consola
                console.log('Error detallado:', error);
                alert('Error al conectar: ' + error.message);
            }
        }
        
        function disconnectDevice() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }
        }
        
        function onDisconnected() {
            statusText.textContent = 'Desconectado';
            batteryText.textContent = '';
            connectButton.textContent = 'Conectar dispositivo';
            connectButton.removeEventListener('click', disconnectDevice);
            connectButton.addEventListener('click', connectToDevice);
            
            // Ocultar tarjetas
            temperatureCard.classList.add('hidden');
            recipeProgressCard.classList.add('hidden');
            actionRequiredCard.classList.add('hidden');
            controlsCard.classList.add('hidden');
            
            // Resetear variables
            device = null;
            batteryCharacteristic = null;
            tempCharacteristic = null;
            progressCharacteristic = null;
            stepsCharacteristic = null;
            continueCharacteristic = null;
            
            // Detener el timer autom√°tico al desconectar
            stopAutomaticTimer();
        }
        
        function handleBatteryChange(event) {
            updateBatteryLevel(event.target.value);
        }
        
        function updateBatteryLevel(value) {
            const batteryLevel = value.getUint8(0);
            batteryText.textContent = `Bater√≠a: ${batteryLevel}%`;
        }
        
        function handleTemperatureChange(event) {
            updateTemperature(event.target.value);
        }
        
        function updateTemperature(value) {
            // La temperatura es un uint16 (2 bytes)
            const temp = value.getUint16(0, false); // false = big-endian
            currentTemp.textContent = `${temp}¬∞C`;
        }
        
        function handleContinueChange(event) {
            const continueValue = event.target.value.getUint8(0);
            if (continueValue === 1) {
                // La acci√≥n ya fue atendida en el dispositivo
                actionRequiredCard.classList.add('hidden');
            }
        }
        
        async function sendContinueSignal() {
            if (!continueCharacteristic) return;
            
            try {
                // Enviar se√±al de continuar (valor 1)
                const value = new Uint8Array([1]);
                await continueCharacteristic.writeValue(value);
                
                // Ocultar tarjeta de acci√≥n requerida
                actionRequiredCard.classList.add('hidden');
                
                statusText.textContent = 'Acci√≥n completada';
            } catch (error) {
                console.error('Error al enviar se√±al de continuar:', error);
                statusText.textContent = 'Error: ' + error.message;
            }
        }
        
        // Funciones para enviar datos al dispositivo
        
        async function sendRecipeStep(step, totalSteps, actionRequired, tempTarget) {
            if (!stepsCharacteristic) return;
            
            try {
                // Crear array de 5 bytes:
                // [paso actual, total pasos, acci√≥n requerida, tempTarget MSB, tempTarget LSB]
                const data = new Uint8Array([
                    step, 
                    totalSteps,
                    actionRequired ? 1 : 0,
                    (tempTarget >> 8) & 0xFF,
                    tempTarget & 0xFF
                ]);
                
                await stepsCharacteristic.writeValue(data);
                
                // Actualizar UI seg√∫n los valores enviados
                stepInfo.textContent = `Paso: ${step}/${totalSteps}`;
                recipeProgressCard.classList.remove('hidden');
                
                if (tempTarget > 0) {
                    tempSetpoint.textContent = `${tempTarget}¬∞C`;
                    setpointContainer.classList.remove('hidden');
                }
                
                if (actionRequired) {
                    actionRequiredCard.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Error al enviar paso de receta:', error);
                statusText.textContent = 'Error: ' + error.message;
            }
        }
        
        async function sendRecipeProgress(remainingTime, totalTime) {
            if (!progressCharacteristic) return;
            
            try {
                // Crear array de 4 bytes:
                // [remainingTime MSB, remainingTime LSB, totalTime MSB, totalTime LSB]
                const data = new Uint8Array([
                    (remainingTime >> 8) & 0xFF,
                    remainingTime & 0xFF,
                    (totalTime >> 8) & 0xFF,
                    totalTime & 0xFF
                ]);
                
                await progressCharacteristic.writeValue(data);
                
                // Actualizar UI
                updateTimeDisplay(remainingTime, totalTime);
                
            } catch (error) {
                console.error('Error al enviar progreso de receta:', error);
            }
        }
        
        function updateTimeDisplay(remainingTime, totalTime) {
            // Calcular minutos y segundos
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            
            // Formatear tiempo (mm:ss)
            const timeStr = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            timeRemaining.textContent = timeStr;
            
            // Actualizar barra de progreso
            let progress = 0;
            if (totalTime > 0) {
                progress = Math.floor(100 * (1 - remainingTime / totalTime));
            }
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${progress}%`;
        }
        
        // Nuevas funciones para controles manuales
        
        async function sendRecipeStepManual() {
            if (!stepsCharacteristic) {
                alert('Dispositivo no conectado o caracter√≠stica Steps no disponible');
                return;
            }
            
            const step = parseInt(document.getElementById('stepNumber').value);
            const totalSteps = parseInt(document.getElementById('totalStepsInput').value);
            const tempSetpoint = parseInt(document.getElementById('targetTemp').value);
            const actionReq = parseInt(document.getElementById('actionRequired').value);
            
            if (isNaN(step) || isNaN(totalSteps) || isNaN(tempSetpoint) || step < 0 || totalSteps < 0 || tempSetpoint < 0) {
                alert('Por favor, completa todos los campos con valores v√°lidos:\n- Paso: 0-10\n- Total Pasos: 0-10\n- Temperatura: 0-300¬∞C');
                return;
            }
            
            console.log(`üìã Steps BLE - Paso: ${step}/${totalSteps}, Setpoint: ${tempSetpoint}¬∞C, Acci√≥n: ${actionReq ? 'Requerida' : 'No requerida'}`);
            
            await sendRecipeStep(step, totalSteps, actionReq === 1, tempSetpoint);
            statusText.textContent = `‚úÖ Steps enviado: Paso ${step}/${totalSteps}, ${tempSetpoint}¬∞C, ${actionReq ? 'Con acci√≥n' : 'Sin acci√≥n'}`;
        }
        
        async function sendRecipeProgressManual() {
            if (!progressCharacteristic) {
                alert('Dispositivo no conectado o caracter√≠stica Progress no disponible');
                return;
            }
            
            const totalStepTime = parseInt(document.getElementById('totalTimeInput').value);
            
            if (isNaN(totalStepTime) || totalStepTime <= 0) {
                alert('Tiempo inv√°lido. Verificar:\n- Tiempo Total del Paso: 1-7200 seg (1 seg a 2 horas)');
                return;
            }
            
            // Inicializar remaining time igual al total time
            const remainingTime = totalStepTime;
            
            // Convertir a formato mm:ss para mostrar
            const totalMin = Math.floor(totalStepTime / 60);
            const totalSec = totalStepTime % 60;
            
            console.log(`‚è±Ô∏è Progress BLE - Iniciando timer: ${totalStepTime}s (${totalMin}:${totalSec.toString().padStart(2,'0')}) - Remaining = Total al inicio`);
            
            // Enviar el tiempo inicial (ambos valores iguales)
            await sendRecipeProgress(remainingTime, totalStepTime);
            
            // Iniciar el contador autom√°tico
            startAutomaticTimer(remainingTime, totalStepTime);
            
            statusText.textContent = `‚è±Ô∏è Timer iniciado: ${totalMin}:${totalSec.toString().padStart(2,'0')} (Countdown autom√°tico activado)`;
        }
        
        // Funci√≥n mejorada para las recetas con timer autom√°tico
        async function sendRecipeProgressWithTimer(totalTime) {
            // Simplificar: remaining time = total time al inicio
            const remainingTime = totalTime;
            
            // Enviar el tiempo inicial
            await sendRecipeProgress(remainingTime, totalTime);
            
            // Iniciar contador autom√°tico
            startAutomaticTimer(remainingTime, totalTime);
        }
        
        // Actualizar las recetas para usar la nueva funci√≥n simplificada
        
        async function startPaellaRecipe() {
            if (!device || !device.gatt.connected) {
                alert('Dispositivo no conectado');
                return;
            }
            
            statusText.textContent = 'ü•ò Iniciando Paella Valenciana...';
            
            // Paso 1: Calentar aceite de oliva
            await sendRecipeStep(1, 4, false, 180);
            await sendRecipeProgressWithTimer(300); // 5 minutos
            
            setTimeout(async () => {
                // Paso 2: Sofre√≠r pollo y verduras - REQUIERE ACCI√ìN
                statusText.textContent = 'ü•ò A√±adir pollo y verduras';
                await sendRecipeStep(2, 4, true, 160);
                await sendRecipeProgressWithTimer(600); // 10 minutos
                
                setTimeout(async () => {
                    // Paso 3: A√±adir arroz y caldo
                    statusText.textContent = 'ü•ò A√±adir arroz y caldo';
                    await sendRecipeStep(3, 4, true, 100);
                    await sendRecipeProgressWithTimer(1200); // 20 minutos
                    
                    setTimeout(async () => {
                        // Paso 4: Socarrat final
                        statusText.textContent = 'ü•ò Socarrat final';
                        await sendRecipeStep(4, 4, false, 200);
                        await sendRecipeProgressWithTimer(300); // 5 minutos
                    }, 3000);
                }, 3000);
            }, 2000);
        }
        
        async function startSteakRecipe() {
            if (!device || !device.gatt.connected) {
                alert('Dispositivo no conectado');
                return;
            }
            
            statusText.textContent = 'ü•© Iniciando Filete a la Plancha...';
            
            // Paso 1: Precalentar sart√©n bien caliente
            await sendRecipeStep(1, 3, false, 240);
            await sendRecipeProgressWithTimer(240); // 4 minutos
            
            setTimeout(async () => {
                // Paso 2: A√±adir filete - REQUIERE ACCI√ìN
                statusText.textContent = 'ü•© Colocar filete en la sart√©n';
                await sendRecipeStep(2, 3, true, 220);
                await sendRecipeProgressWithTimer(300); // 5 minutos
                
                setTimeout(async () => {
                    // Paso 3: Voltear filete - REQUIERE ACCI√ìN
                    statusText.textContent = 'ü•© Voltear el filete';
                    await sendRecipeStep(3, 3, true, 200);
                    await sendRecipeProgressWithTimer(240); // 4 minutos
                }, 3000);
            }, 2000);
        }
        
        // Helper: inicia el timer con callback al finalizar (sin usar setTimeout externos)
        function startAutomaticTimerWithCallback(remainingTime, totalTime, callback) {
            // Detener cualquier timer anterior
            stopAutomaticTimer();

            currentRemainingTime = remainingTime;
            currentTotalTime = totalTime;
            isTimerActive = true;

            // Refrescar UI inmediata
            updateTimeDisplay(currentRemainingTime, currentTotalTime);

            // Intervalo de 1s con env√≠o al perif√©rico
            timerInterval = setInterval(async () => {
                if (!isTimerActive || !device || !device.gatt.connected) {
                    stopAutomaticTimer();
                    return;
                }

                currentRemainingTime--;

                if (currentRemainingTime <= 0) {
                    currentRemainingTime = 0;
                    updateTimeDisplay(0, currentTotalTime);

                    // √öltima actualizaci√≥n al perif√©rico a 0
                    try { await sendRecipeProgressUpdate(0, currentTotalTime); } catch (e) {}

                    stopAutomaticTimer();

                    // Lanzar siguiente paso tras finalizar el countdown
                    if (typeof callback === 'function') {
                        setTimeout(callback, 200);
                    }
                    return;
                }

                // Actualizaci√≥n de UI + perif√©rico en cada tick
                updateTimeDisplay(currentRemainingTime, currentTotalTime);
                try {
                    await sendRecipeProgressUpdate(currentRemainingTime, currentTotalTime);
                } catch (error) {
                    console.error('Error enviando actualizaci√≥n de tiempo:', error);
                    stopAutomaticTimer();
                }
            }, 1000);
        }

        // Helper: env√≠a remaining=total y espera a que termine para ejecutar el callback
        async function sendRecipeProgressAndWait(totalTime, nextStepCallback) {
            const remaining = totalTime;
            await sendRecipeProgress(remaining, totalTime);
            startAutomaticTimerWithCallback(remaining, totalTime, nextStepCallback);
        }

        // Ajuste: Receta de Pasta sin setTimeout; avanza solo al terminar cada countdown
        async function startPastaRecipe() {
            if (!device || !device.gatt.connected) {
                alert('Dispositivo no conectado');
                return;
            }

            statusText.textContent = 'üçù Iniciando Pasta Italiana...';

            // Paso 1: Hervir agua
            await sendRecipeStep(1, 3, false, 100);
            await sendRecipeProgressAndWait(480, async () => {
                // Paso 2: A√±adir pasta - requiere acci√≥n
                statusText.textContent = 'üçù A√±adir pasta al agua hirviendo';
                await sendRecipeStep(2, 3, true, 100);
                await sendRecipeProgressAndWait(600, async () => {
                    // Paso 3: Escurrir pasta - requiere acci√≥n
                    statusText.textContent = 'üçù Escurrir la pasta';
                    await sendRecipeStep(3, 3, true, 0);
                    await sendRecipeProgressAndWait(60, () => {
                        statusText.textContent = 'üçù ¬°Pasta Italiana completada!';
                    });
                });
            });
        }
        
        async function resetRecipe() {
            if (!device || !device.gatt.connected) {
                alert('Dispositivo no conectado');
                return;
            }
            
            // Detener el timer autom√°tico
            stopAutomaticTimer();
            
            // Enviar paso 0 para resetear
            await sendRecipeStep(0, 0, false, 0);
            await sendRecipeProgress(0, 0);
            
            // Ocultar tarjetas de progreso y acci√≥n
            recipeProgressCard.classList.add('hidden');
            actionRequiredCard.classList.add('hidden');
            setpointContainer.classList.add('hidden');
            
            statusText.textContent = 'Receta reseteada (Timer detenido)';
        }
        
        // A√±adir funci√≥n para mostrar informaci√≥n de versi√≥n - ACTUALIZADA
        function showVersionInfo() {
            const versionDetails = `
SmartCookware Web App
Versi√≥n: 2.5.0
Build: 20241212-005
Fecha: ${new Date().toLocaleDateString()}

Nuevas caracter√≠sticas v2.5.0:
‚úì UI simplificada para env√≠o de tiempo
‚úì Inicio autom√°tico de timer desde tiempo total

Caracter√≠sticas incluidas:
‚úì Conexi√≥n BLE con SmartCookware
‚úì Monitoreo de temperatura en tiempo real
‚úì Monitoreo de bater√≠a
‚úì Controles manuales de receta
‚úì Recetas predefinidas (Paella, Filete, Pasta)
‚úì Sistema de acciones requeridas

Compatibilidad:
‚Ä¢ Chrome para Android
‚Ä¢ Chrome para Desktop
‚Ä¢ Microsoft Edge (versiones recientes)
            `;
            
            alert(versionDetails);
        }
        
        // Mostrar versi√≥n en la consola al cargar - ACTUALIZADO
        window.addEventListener('load', () => {
            console.log('%c SmartCookware Web App v2.5.0 ', 'background: #4CAF50; color: white; font-weight: bold; padding: 5px;');
            console.log('Build: 20241212-005');
            console.log('Loaded at:', new Date().toLocaleDateString());
            console.log('New features: Simplified timer UI, automatic start from total time');
        });
        
        // Funci√≥n para iniciar el contador autom√°tico
        function startAutomaticTimer(remainingTime, totalTime) {
            // Detener cualquier timer anterior
            stopAutomaticTimer();
            
            currentRemainingTime = remainingTime;
            currentTotalTime = totalTime;
            isTimerActive = true;
            
            console.log(` Iniciando contador autom√°tico: ${remainingTime}s de ${totalTime}s`);
            
            // Actualizar UI inmediatamente
            updateTimeDisplay(currentRemainingTime, currentTotalTime);
            
            // Iniciar intervalo de 1 segundo
            timerInterval = setInterval(async () => {
                if (!isTimerActive || !device || !device.gatt.connected) {
                    stopAutomaticTimer();
                    return;
                }
                
                // Decrementar tiempo
                currentRemainingTime--;
                
                // Verificar si el tiempo se agot√≥
                if (currentRemainingTime <= 0) {
                    currentRemainingTime = 0;
                    console.log(' Tiempo agotado!');
                    statusText.textContent = '¬°Tiempo del paso completado!';
                    stopAutomaticTimer();
                }
                
                // Actualizar UI local
                updateTimeDisplay(currentRemainingTime, currentTotalTime);
                
                // Enviar actualizaci√≥n al perif√©rico
                try {
                    await sendRecipeProgressUpdate(currentRemainingTime, currentTotalTime);
                } catch (error) {
                    console.error('Error enviando actualizaci√≥n de tiempo:', error);
                    // Si hay error de comunicaci√≥n, detener el timer
                    stopAutomaticTimer();
                }
                
            }, 1000); // Cada 1000ms = 1 segundo
        }
        
        // Funci√≥n para detener el contador autom√°tico
        function stopAutomaticTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                isTimerActive = false;
                console.log(' Contador autom√°tico detenido');
            }
        }
        
        // Funci√≥n para enviar actualizaciones de tiempo (sin mostrar en UI)
        async function sendRecipeProgressUpdate(remainingTime, totalTime) {
            if (!progressCharacteristic) return;
            
            try {
                // Crear array de 4 bytes:
                // [remainingTime MSB, remainingTime LSB, totalTime MSB, totalTime LSB]
                const data = new Uint8Array([
                    (remainingTime >> 8) & 0xFF,
                    remainingTime & 0xFF,
                    (totalTime >> 8) & 0xFF,
                    totalTime & 0xFF
                ]);
                
                await progressCharacteristic.writeValue(data);
                
                // Solo log cada 10 segundos para no saturar la consola
                if (remainingTime % 10 === 0 || remainingTime <= 5) {
                    console.log(` Tiempo actualizado: ${remainingTime}s restantes de ${totalTime}s`);
                }
                
            } catch (error) {
                console.error('Error al enviar actualizaci√≥n de tiempo:', error);
                throw error; // Re-lanzar para que el timer se detenga
            }
        }
        
        async function testContinueNotification() {
            if (!continueCharacteristic) {
                alert('Caracter√≠stica de continuar no disponible');
                return;
            }
            try {
                // Simular que se requiere una acci√≥n
                await sendRecipeStep(1, 1, true, 150);
                
                setTimeout(() => {
                    statusText.textContent = 'Test: Mostrando acci√≥n requerida (v2.5.0)';
                }, 1000);
            } catch (error) {
                console.error('Error en test:', error);
                statusText.textContent = 'Error en test: ' + error.message;
            }
        }
        
        // Nueva funci√≥n para acelerar al siguiente paso
        async function nextStep() {
            if (!device || !device.gatt.connected) {
                alert('Dispositivo no conectado');
                return;
            }
            
            if (!isTimerActive) {
                alert('No hay timer activo para acelerar');
                return;
            }
            
            // Acelerar el paso actual fijando el tiempo restante a 3 segundos
            currentRemainingTime = 3;
            
            // Enviar la actualizaci√≥n inmediatamente al perif√©rico
            try {
                await sendRecipeProgressUpdate(currentRemainingTime, currentTotalTime);
                statusText.textContent = '‚è© Acelerando al siguiente paso... (3 segundos)';
                console.log('‚è© Paso acelerado: tiempo restante fijado a 3 segundos');
            } catch (error) {
                console.error('Error al acelerar paso:', error);
                statusText.textContent = 'Error al acelerar paso: ' + error.message;
            }
        }
    </script>
</body>
</html>